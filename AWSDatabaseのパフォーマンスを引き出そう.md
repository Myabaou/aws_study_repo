# データベースのパフォーマンスを最大まで引き出そう

URL: https://aws-startup-lofts.com/apj/event/4da1d396-42a6-4775-86d9-7bccd18903f6

## 開催概要

簡単なようで難しいリレーショナルデータベース。
パフォーマンスの改善方法がスケールアップ（大きいスペックへ変更）のみに
なっているスタートアップも多いのではないでしょうか。

このセッションではリレーショナルデータベースのパフォーマンスチューニングのコツを、
初心者でもわかりやすい内容で、基本的な考え方から、
具体的な調査方法とチューニング手法を交えてお話します。

チョークトーク形式（スピーカーと参加者が比較的インタラクティブにやり取りするイベント形式）で行うため、
一緒にディスカッションを行い理解を深めましょう！



## 開催場所

AWS Startup Loft Tokyo 内の Ask an Expert カウンター横のホワイトボードのあるエリアで行います。（
キャパシティの都合上、立ち見になる可能性もございます）

## 実行計画の見方

- EXPLAIN ← これは予想
プランなが生成する実行計画を確認可

実行計画では関連するテーブルのスキャン方方や結像アルゴリズムを確認するととともうに
実行に関わるコストを確認します。


ANALYZEオプション（実際に実行して処理時間や統計情報を取得する。）

PlannningTime 考える時間
ExcutionTime 実行にかかる時間

costは重い　軽い判断

## SQL分析例

IndexScan
SeqScan


単体でみるとIndexScanのほうが早いが
100回ループした場合早く終わるのがフルスキャン(SeqScan)のほうが早い。

実行数を増やすことで誤差をなくすことが可能。

Buffers: Shared hit が減ったほうが早い。
→ メモリから読み込む量。

ただし、ディスクから読んだほうが早いケースもある。

セッション単位でフルスキャン、インデックススキャン指定可能

### 遅延SQLの分析

SQLの性能ではデータ量と件数が問題になるケースがある
どちらの観点も常に確認するように注意


チューニングで本番環境でしかできないと
できることが狭まるので検証環境など再現することができる環境を準備する必要がある。


WITH句を利用すると早くなった。　　　　　　　　　　　★

バインド変数を使用　　　　　　　　　　　　　　　　　  ★
→ バインド変数化による書き換え

演算系はアプリケーション側によせていくとスケールしやすい。


- Explainから読み解けない場合

- 複数結合時のチューニング
制限値を設けることが重要
制限値がないとテストしようがない。
→ mysqlの結合っていくつまでいけますか？　→ ×

制限を設けるようにしたほうが安全だし負荷性能も測りやすい。

実行計画をみて判断する。

以下に早い段階で絞り込むか探す
→分割して実行速度を計測
　→ チューニング知識が不足している場合でも、分割実行で見極められるケースもあり。

その結合方式がいいんだろうか。。
トライアンドエラーで分析できるケースがある。


## 性能問題発生時の調査観点

1. 遅延検知の方法
スロークエリやパフォーマンスインサイトで実行速度を確認
2. 手動実行での再現性確認
- 手動実行で遅延が再現するか。
※再現しない場合、実行条件を合わせる必要あり
- 連続実行した場合の再現性（キャッシュや、PlanningTimeの場合は、PREPARE(5回以下　or 6回以上の実行)による変化を確認）
- アプリケーションからの単体実行で再現するか、負荷シナリオを流した条件で再現するか。
→再現する場合は遅延発生時に手動実行で事象再現するか。
※実行計画は完全一致している前提


## 更新系処理の調査方法と注意点

UPDATE文のexplain analyze

! explain analyzeは実際にSQLが実行されます。
本番環境などデータが変更できない環境ではSELECT文での確認を検討してください。

## ロングトランザクションの注意点　postgres特有

アイドルトランザクションによる遅延も意識する。


遅延理由なので読み込みバッファが増えていることによる影響とかもあったりする。




